
# Foundational Lab - Conditional Access Basics

## Implement and test a conditional access policy

#### Lab scenario
Your organization needs to be able to limit user access to its internal applications. You must deploy an Microsoft Entra conditional access policy.

- Estimated time: 20 minutes

### Exercise 1 - Set a conditional access policy to block DebraB from accessing Sway

#### Task 1 -- Confirm DebraB has access to Sway

1. Launch a new InPrivate browser window.

1. Connect to https://www.office.com.

1. When prompted, log in as DebraB:

| Setting | Value |
| :--- | :--- |
| Username | DebraB@ <<your lab domain>>.onmicrosoft.com |
| Password | Enter the provided password |

1. Use **Cancel** to bypass the welcome and introduction screens.

1. Open the Apps page, then then select on the Sway icon to see that it loads correctly.

1. Log out of Office and close your browser session.

#### Task 2 - Create a conditional access policy

Microsoft Entra conditional access is an advanced feature of Microsoft Entra ID that allows you to specify detailed policies that control who can access your resources. Using Conditional Access, you can protect your applications by limiting users' access based on things like groups, device type, location, and role.

1. Browse to the **Entra admin center at** https://entra.microsoft.com and sign in using the provided administrator account for the directory.

1. Open the portal menu and then select Entra ID section.

1. Select Protection.

1. On the **Security page**, in the left navigation, select **Conditional access**.

1. On the Overview, select **+ Create** new policy.

1. In the **Name** box, enter Block Sway for DebraB.

  >Note - Using concise naming helps you quickly recognize the policy and its function.

1. Under Assignments, select 0 users and groups selected.

1. On the Include tab, select Select users and groups, and then mark Users and groups check box.

1. In the Select pane, select DebraB account and then select Select.

1. In the Target resources, select No target resource selected.

1. Verify Cloud apps is selected and then select Select apps, then select None in the select section.

1. In the Select pane, search for Sway and select Sway and then select Select.

1. Under Access controls, within the Grant section, select 0 controls selected.

1. In the Grant pane, select Block access and then select Select.

  >Note - This policy is being configured for the exercise only and is being used to quickly demonstrate a conditional access policy.

1. Under Enable policy, select On, and then select Create.

#### Task 3 - Test the conditional access policy
You should test your conditional access policies to ensure they working as expected.

1. Open a new 'InPrivate' browser tab and then browse to https://sway.cloud.microsoft.

1. When prompted, log in as DebraB:

| Setting | Value |
| :--- | :--- |
| Username | DebraB@ <<your lab domain>>.onmicrosoft.com |
| Password | Enter the provided password |

1. Verify you are prevented from accessing Microsoft Sway.

  >Lab tip - It make take a couple of minutes to the CA policy to take effect.

1. If you are signed in, close the tab, wait 1 minute, and then retry.

  >Note - If you are auto-logged into Sway as DebraB, then you will need to manually log out. Your credentials / access were cached. Once you log out and sign-in, your Sway session should deny access.

1. Close the browser and return to the Conditional Access page.

1. Select the Block Sway for DebraB policy.

1. Under Enable policy, select Off and then select Save.

--- 

### Exercise 2 - Test conditional access policies with "What if"

#### Task - Use What if to test conditional access policies

1. Open the Edge browser.

1. Open the Microsoft Entra admin center at https://entra.microsoft.com.

1. On the menu under **Entra ID**, select **Protection**.

1. On the **Security** page, in the left navigation, select **Conditional access**.

1. In the navigation pane, select **Policies**.

1. Select **What If**.

1. Under User or **Workload identity**, select No user or service principal selected.

1. Choose **DebraB** as the user.

1. Under **Cloud apps, actions, or authentication** context, select **Sway**.

1. Select **What if**.

  >Outcome - You will be provided with a report at the bottom of the tile for Policies that will apply and Policies that will not apply.

1. This allows you to test the policies and their affectiveness before enabling the policies.

--- 

### Exercise 3 - Configure sign in frequency controls using a conditional access policy

#### Task - Use the Microsoft Entra admin center to configure conditional access

As part of your company's larger security configuration, you must test a conditional access policy that can be used to control sign in frequency

1. Browse to https://entra.microsoft.com and sign in using the administrator account provided.

1. On the menu, under **Entra ID**, select **Protection**.

1. On the **Protection** menu, in the left navigation, select **Conditional access**.

1. On the top menu, select **+ New policy** from the drop-down select **Create a new policy**.

1. In the Name box, enter Sign in frequency.

1. Under Assignments, select **0 users and groups selected**.

1. On the **Include** tab, mark **Select users and groups**, then select the **Users and groups** check box.

1. In the Select pane, mark the **Grady Archie** account and then select **Select**.

1. Select **Target Resources - No target resources selected**.

1. Within the **Include** make sure **Select resources** is selected, then choose **None** in the Select section.

1. In the **Select** pane, select **Office 365** and then select Select.

1. Under **Access controls**, select **Session**.

1. In the Session pane, select **Sign-in frequency**.

1. In the value box, enter 30.

1. Select the units menu, select **Days**, and then select **Select**.

1. Under **Enable policy**, select **Report-only**.

1. Select **Create**.

  >NOTE - Report-only mode is a new Conditional Access policy state that allows administrators to evaluate the impact of Conditional Access policies before enabling them in their environment. With the release of report-only mode:

     - Conditional Access policies can be enabled in report-only mode.
     - During sign-in, policies in report-only mode are evaluated but not enforced.
     - Results are logged in the Conditional Access and Report-only tabs of the Sign-in log details.
     - Customers with an Azure Monitor subscription can monitor the impact of their Conditional Access policies using the Conditional Access insights workbook.
     
=== 



# Agent Lab - Conditional Access Optimization Agent (Microsoft Entra)

#### Lab Prerequisites (configuration on this machine)

**Licensing**:

- Microsoft Entra ID P1 license (minimum).
-	Risk-based suggestions (e.g., risky users/sign-ins) require Microsoft Entra ID P2.

**Capacity**:

- Available Security Compute Units (SCU); on average, each agent run consumes less than 1 SCU.

**Roles / Permissions**:

- Need Roles for Students:
- Conditional Access Administrator and Global Reader (view-only)

**To configure**:

- Activate the agent the first time: Security Administrator or Global Administrator.

#### Lab Duration
- 60 minutes

---

## Exercise 1: Configure the Conditional Access policy that Blocks legacy authentication

- Estimated time: 10 minutes
- Role: Conditional Access Admin

#### Description

Create a Conditional Access policy, confirm in Read-only mode, become familiar with the basic concept of CA policies. In this activity, we will block legacy authentication for a specific user(s). In doing so, you will understand the basics of creating a CA policy.

1. Sign in to the **Microsoft Entra admin center** at https://entra.microsoft.com with your **Conditional Access Administrator** account.

1. Browse to **Entra ID > Conditional Access > Policies**.

1. Select **+ New policy**.

1. Give your policy a name. We recommend that organizations create a meaningful standard for the names of their policies. For lab purposes, just remember the name so you can locate it after creation.

1. Under **Assignments**, select **Users** or workload identities.

  - Under **Include**, select **All users**.
  - Under **Exclude**, select **Users and groups**, and choose any accounts for demonstration purposes. Microsoft recommends you exclude at least one account to prevent yourself from being locked out due to misconfiguration.

1. Accept by clicking **Select**.

1. Under **Target resources > Resources > Include**, select **Select resources**. 

  - Select **Office 365**. Note, this is for demonstration purposes only. Microsoft's general recommendation is to set this for All resources. 
  - Accept by using **Select**.

1. Under **Conditions > Client apps**, set **Configure to Yes**.

  - **Check** only the boxes **Exchange ActiveSync clients** and **Other clients**.
  - Select **Done**.

1. Under **Access controls > Grant**, select **Block access**.

  - Use the **Select** button to confirm.

1. Review your settings and set **Enable policy** to **Report-only**.
1. Select **Create** to create to enable your policy.

===

## Exercise 2: Review Results of Agent run

- Estimated Time: ~15 min|  Difficulty: Beginner
- Role: Conditional Access Admin

#### Description

Review Policy details, analyze Policy impact, inspect the Agent activity map, and become familiar with the different recommendations the agent has provided. This is the first action taken after a new agent run, intended for review during normal operations.

1. Sign in to the **Microsoft Entra admin center** at https://entra.microsoft.com with your **Conditional Access Administrator** account.

1. Review the **Overview** page and locate the **Agents** section in the top left of the screen.

1. Select **Agents**, then select **Conditional Access Optimization Agent**

1. Select **View details › Overview**.

1. Under **Agent is active**, select **View agent's full activity**.

1. Under **Summary of agent activity**, read the description to understand a summary of the last agent run. 

  >Note: This section explains the agent's findings and details the activities planned for this lab.

1. Under **Agent activity map**, review the information.

  >Note: This breaks down each check that the agent reviews and outlines how the agent determined its recommendations.

1. Using your mouse, **hold left mouse button while drag the screen (left to right)** to explore the different recommendations. You may click on the hyperlinks to deep dive into contextual information.

1. Spend **2-3 minutes reviewing** the insights while becoming familiar with each scenario as it aligns to the agent logic.

1. **Exit** the **summary Agent activity map** by selecting the top right corner **Close 'X'** icon.

1. This returns you to the **Agent summary** screen.

===

## Exercise 3: Merge suggested policies

- Estimated Time: 8 min
- Role: Conditional Access Admin

#### Description
In this task, you will identify consolidation opportunities across your tenant's Conditional Access policies. To begin with, the Conditional Access optimization agent will perform a scan of your policies-either daily or on demand. During this scan, the agent analyzes your environment to detect duplicate or redundant policies by evaluating overlapping grant controls and similar policy pairs. Your role is to review and validate the agent's findings. The agent will never modify production policies without your explicit approval. Instead, it presents suggested changes in a transparent and safe manner, allowing you to assess their impact before applying them.

1. Sign in to the **Microsoft Entra admin center** at https://entra.microsoft.com with your **Conditional Access Administrator** account.

1. Navigate to **Agents (top left of page)** › **Conditional Access Optimization Agent (Select View details)** › **Overview**. 

1. Under **Recent suggestions**, locate the column **Suggested next steps**.

1. Find the row with the text information starting with **Turn on Merged** `policy1` and `policy2`.

1. On the **furthest right of the column** for the **Turn on Merged** suggestion, select **Review suggestion**.

  >Note: the format of the suggestions combines the insight action with the policy name. For example: Turn on Merged (the action) JWT1_MFA and JWT2_MFA (the two policy names).

1. Read the **Suggestion: Agent summary** to understand why it is making this recommendation.

1. Let us investigate this further by select the **Chat with agent (Preview)**.

1. **Ask the agent** to Tell me more about this recommendation.

1. **Read the information** to understand why the agent has provided the recommendation.

1. Select **Turn on policy**, which will apply the new policy that the agent suggests.

===

## Exercise 4: Read CA policy with high exclusions

- Estimated Time: 8 min
- Role: Conditional Access Admin

#### Description
This task focuses on identifying and resolving misaligned exclusions in a Conditional Access policy. It supports proactive policy hygiene by surfacing high-impact gaps in enforcement and guiding admins to make targeted corrections. The Agent also analyzes exclusions-flagging policies that exclude a substantial portion of users and recommending explicit exclusion of break glass accounts to reduce the risk of accidental lockout.

1. Sign in to the **Microsoft Entra admin center** at https://entra.microsoft.com with your **Conditional Access Administrator** account.

1. Navigate to **Agents (top left of page)** › **Conditional Access Optimization Agent (Select View details)** › **Overview**. 

1. Under **Recent suggestions**, locate the column **Suggested next steps**.

1. **Find the row** with the text information with **Review policy** `policy name` with **high exclusion count**.

  >Note: the policy name is the name of the policy that the agent detected.

1. On the **furthest right of the column** for the **high exclusion count suggestion**, select **Review suggestion**. 

1. **Read** the **Suggestion: Agent summary** to understand why it is making this recommendation.

1. Select **View all excluded identities** to see a list of recommended identities to remove from this policy.

1. You can randomly select **1-2 users to remove from the policy** by using the **Remove** option.

1. Then select **Save** to confirm the change.

1. Next to the **View agent's full activity**, select the **edit notes** button

1. **Add** a **self-note** such as: We removed users from this policy since they no longer required to be excluded. 

1. Select **Save** to confirm this note that you entered. 

1. To complete this lab task, **confirm** your note has now appeared in the agent suggestion policy details. 

===

## Exercise 5: Investigate Sign-In Spikes

- Estimated Time: 8 min  |  Difficulty: Beginner  |  
- Role: Conditional Access Admin

#### Description
In this task, you will use the Conditional Access Optimization Agent to detect sign-in spikes caused by problematic policies. You will begin by analyzing sign-in patterns across your tenant. The agent will automatically flag Conditional Access policies that are contributing to unexpected increases in failed sign-ins.
These spikes may result in: 

- User lockouts and productivity loss
- Helpdesk overload
- Reactive policy changes that weaken your security posture

Your objective is to review the flagged policies and investigate the root cause insights provided by the agent, including affected users, apps, and recent policy changes. This will enable you to take informed, timely action to remediate issues before they escalate.

1. Sign in to the **Microsoft Entra admin center** at https://entra.microsoft.com with your **Conditional Access Administrator** account.

1. Navigate to **Agents (top left of page)** › **Conditional Access Optimization Agent (Select View details)** › **Overview**. 
 
1. Under **Recent suggestions**, locate the column **Suggested next steps**.

1. Find the row with the text information with **Review Increase in Failed Sign-Ins** caused by `policy name`. 

  >Note: the policy name is the name of the policy that the agent detected.

1. Look for the **furthest right of the column** for the **high exclusion count suggestion**, select **Review suggestion**. 

1. Read the **Suggestion: Agent summary** to understand why it is making this recommendation.

1. Open the **Review Report** and see **summary and chart of the total failed sign-in's**.

1. **Review the Report** by scrolling down.
 
1. Find the **Root cause analysis**, **Non-factors**, and **Potential next steps**.

1. When you read to the bottom, select **Close**.

  >Note: This will take you back to the **Conditional Access Optimization Agent Suggestion** page.

1. **Navigate** to the **Overview agent summary** page using the instructions in **step 2**.

1. Select the **Review Increase in Failed Sign-Ins** caused by `policy name` again to dive back into the recommendation section. 

1. Select the **Mark suggestions as reviewed** item. 

1. To complete task, **locate the policy and confirm** that it states **Reviewed** under the **Status** column. 

===

## Exercise 6: Initiate Phased Rollout

- Estimated Time: 8 min
- Role: Conditional Access Admin

#### Description

In this task, you will use the Conditional Access Optimization Agent to implement a phased rollout of policy optimization across your tenant. This approach allows you to gradually apply changes, monitor impact, and reduce risk during Conditional Access policy updates.
The phased rollout process helps you:

- Minimize disruptions to user sign-ins
- Validate policy effectiveness before full deployment
- Identify and remediate problematic policies early

Your objective is to configure the agent to begin optimization in a limited scope, monitor results, and expand coverage based on success metrics and insights provided by the agent.

1. Sign in to the **Microsoft Entra admin center** at https://entra.microsoft.com with your **Conditional Access Administrator** account.

1. Navigate to **Agents (top left of page)** › **Conditional Access Optimization Agent (Select View details)** › **Overview**. 

1. Under **Recent suggestions**, locate the column **Actions taken by agent** with the value **Suggested phased rollout**.

  >Note: These are recommendations from the agent to begin phased rollout of the Conditional Access policy.

1. On the **furthest right of the column**, select **Review suggestion** to begin a phased rollout.

1. **Review** the **phases** suggested by the agent by selecting **Review phases**.

  >Note: It is common that the agent recommendation may not align with your current rollout process. Let us make a change to the recommendation phase rollout.

1. Locate the **Pilot phase** at the top of the list and **adjust the scope** by selecting **Edit Groups**.

1. For demonstration purposes, **select an additional Group to include** in the Pilot phase.

1. Use the **Select** button to finalize.

1. Now that we are ready to begin our phased rollout, select **Automatically roll out phases**.

1. The **Agent has now created a new enabled policy** and has **immediately started phase 1 policy rollout**.

===

## Exercise 7: Review Results of Phased Rollout

- Estimated Time: 8 min  |  Difficulty: Beginner  |  
- Role: Conditional Access Admin

#### Description
In this task, you will evaluate the effectiveness of a phased Conditional Access policy rollout using the Optimization Agent. After the final phase has completed, the agent provides detailed insights into sign-in behavior, policy impact, and user experience across all groups involved.
This review helps you:

- Validate that the policy changes improved security without harming usability
- Identify any lingering issues or regressions
- Decide whether to keep, revert, or further refine the deployed policies

Your objective is to use the agent's post-rollout analytics to assess performance, compare pre- and post-rollout metrics, and document findings for future reference or escalation.

1. Sign in to the **Microsoft Entra admin center** at https://entra.microsoft.com with your **Conditional Access Administrator** account.

1. Navigate to **Agents (top left of page)** › **Conditional Access Optimization Agent (Select View details)** › **Overview**. 

1. Select the **Review suggestion** from the **previous task for phased rollout**. If you have forgotten, follow these two steps else, go to step 4 below:

  - Under Recent suggestions, locate the column Actions taken by agent with the value "Suggested phased rollout." These are recommendations from the agent to begin phased rollout of the Conditional Access policy.
  - On the furthest right of the column, select Review suggestion to begin a phased rollout.

1. You may now track the status of the rollout by selecting **Review suggestion** then, select **Review phases**. 

1. Confirm that it shows you are in the **Pilot phase** along with the **number of Users enforced**. 

  >Note: When you choose Manually rollout phases, you will have the option to Move to next phase, which takes you to Early Adoption as shown below. If you manually move to the next phase and receive a high failure rate, you can quickly click Roll back to previous phase as part of your plan.

1. Take a moment to **explore these options**.

1. When finished, click Close to go back to the main agent summary Overview.

